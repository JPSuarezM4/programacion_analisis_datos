name: 0-Setup-Environment-Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup:
    name: Configuración inicial (Windows)
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          
      - name: Crear estructura de directorios
        run: |
          if not exist "src\edu_pad\static\db" mkdir src\edu_pad\static\db
          if not exist "src\edu_pad\static\csv" mkdir src\edu_pad\static\csv
          if not exist "src\edu_pad\static\logs" mkdir src\edu_pad\static\logs
        shell: cmd
      
      - name: Actualizar setup.py si es necesario
        run: |
          $setupContent = Get-Content setup.py -Raw
          if ($setupContent -like "*sqlite3-simple*") {
            $updatedContent = $setupContent -replace '"sqlite3-simple",?', ''
            $updatedContent | Set-Content setup.py -Force
            echo "Se eliminó sqlite3-simple de setup.py"
          } else {
            echo "No se encontró sqlite3-simple en setup.py"
          }
        shell: pwsh
          
      - name: Crear entorno virtual
        run: python -m venv venv
        
      - name: Activar entorno virtual
        run: .\venv\Scripts\activate
        shell: pwsh
        
      - name: Instalar dependencias con setup.py
        run: |
          python -m pip install --upgrade pip
          pip install -e .
        shell: pwsh
          
      - name: Verificar instalación
        run: |
          python -c "import pandas; import requests; import openpyxl; from bs4 import BeautifulSoup; import sqlite3; print('Entorno configurado correctamente')"
        shell: pwsh
          
      - name: Preparar estructura del proyecto
        run: |
          REM Copiar los archivos Python al directorio src/edu_pad
          copy database.py src\edu_pad\ 2>nul || echo Archivo no encontrado
          copy dataweb.py src\edu_pad\ 2>nul || echo Archivo no encontrado
          copy main_extractor.py src\edu_pad\ 2>nul || echo Archivo no encontrado
          copy main_ingesta.py src\edu_pad\ 2>nul || echo Archivo no encontrado
          copy monitor.py src\edu_pad\ 2>nul || echo Archivo no encontrado
          
          REM Si no existen, crear archivos vacíos para evitar errores
          if not exist "src\edu_pad\database.py" type nul > src\edu_pad\database.py
          if not exist "src\edu_pad\dataweb.py" type nul > src\edu_pad\dataweb.py
          if not exist "src\edu_pad\main_extractor.py" type nul > src\edu_pad\main_extractor.py
          if not exist "src\edu_pad\main_ingesta.py" type nul > src\edu_pad\main_ingesta.py
          if not exist "src\edu_pad\monitor.py" type nul > src\edu_pad\monitor.py
        shell: cmd
          
      - name: Guardar estructura del proyecto
        uses: actions/upload-artifact@v4
        with:
          name: project-structure-windows
          path: |
            src/
            setup.py
            venv/
          retention-days: 7